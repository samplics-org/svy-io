name: Build and Publish Python Wheels

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:

jobs:
  build-wheels:
    name: Build wheels on ${{ matrix.os }} - Python ${{ matrix.python-version }}${{ matrix.target && format(' ({0})', matrix.target) || '' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-2022, macos-13]
        python-version: ["3.11", "3.12", "3.13"]
        target: [""]
        include:
          # Add ARM64 Linux build
          - os: ubuntu-22.04
            python-version: "3.11"
            target: aarch64-unknown-linux-gnu

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install LLVM (Windows)
        if: runner.os == 'Windows'
        run: choco install llvm -y

      - name: Build wheels
        uses: PyO3/maturin-action@v1
        env:
          # MSVC linker search path for Python import libs
          LIB: ${{ runner.os == 'Windows' && format('{0}\libs', env.pythonLocation) || '' }}
          # Set LIBCLANG_PATH for Windows
          LIBCLANG_PATH: ${{ runner.os == 'Windows' && 'C:\Program Files\LLVM\bin' || env.LIBCLANG_PATH }}
          # diagnostics
          READSTAT_BUILD_DEBUG: "1"
        with:
          command: build
          args: >-
            --release
            --out dist
            --features vendored
          manylinux: "2_28"
          target: ${{ (runner.os == 'Linux') && matrix.target || '' }}
          # sccache can be flaky on macOS runners (remote storage).
          sccache: ${{ runner.os != 'macOS' }}
          before-script-linux: |
            set -eux

            # Avoid host includes leaking into cross builds
            unset CPATH || true
            unset C_INCLUDE_PATH || true
            unset CPLUS_INCLUDE_PATH || true
            unset OBJC_INCLUDE_PATH || true

            # Detect package manager
            PM=""
            for x in microdnf dnf yum apt-get; do
              if command -v "$x" >/dev/null 2>&1; then PM="$x"; break; fi
            done

            # Install dependencies based on package manager
            if [ -n "$PM" ]; then
              if [ "$PM" = "apt-get" ]; then
                apt-get update
                apt-get install -y clang llvm llvm-dev

                # Install zlib for cross-compilation if targeting ARM64
                if [ "${{ matrix.target || '' }}" = "aarch64-unknown-linux-gnu" ]; then
                  dpkg --add-architecture arm64
                  apt-get update
                  apt-get install -y zlib1g-dev:arm64 || apt-get install -y zlib1g-dev
                else
                  # Install native zlib headers
                  apt-get install -y zlib1g-dev
                fi
              elif [ "$PM" = "microdnf" ]; then
                microdnf install -y clang llvm-devel || true

                # Install zlib development headers
                if [ "${{ matrix.target || '' }}" = "aarch64-unknown-linux-gnu" ]; then
                  microdnf install -y zlib-devel.aarch64 || microdnf install -y zlib-devel || true
                else
                  microdnf install -y zlib-devel || true
                fi
              else
                $PM install -y clang llvm-devel || true

                # Install zlib development headers
                if [ "${{ matrix.target || '' }}" = "aarch64-unknown-linux-gnu" ]; then
                  $PM install -y zlib-devel.aarch64 || $PM install -y zlib-devel || true
                else
                  $PM install -y zlib-devel || true
                fi
              fi
            fi

            # libclang discovery for bindgen
            if command -v llvm-config >/dev/null 2>&1; then
              export LIBCLANG_PATH="$(llvm-config --libdir || true)"
            fi
            if [ -z "${LIBCLANG_PATH:-}" ]; then
              for d in /usr/lib64 /usr/lib/llvm/lib /usr/lib/x86_64-linux-gnu /usr/lib/aarch64-linux-gnu; do
                if [ -f "$d/libclang.so" ]; then export LIBCLANG_PATH="$d"; break; fi
              done
            fi
            echo "LIBCLANG_PATH=${LIBCLANG_PATH:-unset}"

            # If cross-compiling, pass sysroot to bindgen via *export* (don't write $GITHUB_ENV inside container)
            if [ "${{ matrix.target || '' }}" = "aarch64-unknown-linux-gnu" ]; then
              if command -v aarch64-unknown-linux-gnu-gcc >/dev/null 2>&1; then
                SYSROOT="$(aarch64-unknown-linux-gnu-gcc -print-sysroot || true)"
                if [ -n "$SYSROOT" ] && [ -d "$SYSROOT" ]; then
                  export BINDGEN_SYSROOT="$SYSROOT"
                  echo "BINDGEN_SYSROOT=$BINDGEN_SYSROOT"
                fi
              fi
            fi

      - name: Show wheels (Unix)
        if: runner.os != 'Windows'
        run: ls -lh dist

      - name: Show wheels (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: Get-ChildItem dist

      # Validate wheel integrity
      - name: Validate wheels (Integrity Check)
        shell: bash
        run: |
          python - <<'PY'
          import glob, zipfile, sys
          bad = False
          for whl in glob.glob("dist/*.whl"):
              ok = zipfile.is_zipfile(whl)
              print(f"{whl}: is_zipfile={ok}")
              if not ok:
                  bad = True
                  continue
              try:
                  with zipfile.ZipFile(whl) as zf:
                      err = zf.testzip()
                      print("  testzip:", err)
                      if err: bad = True
              except Exception as e:
                  print(f"  Error testing zip: {e}")
                  bad = True
          sys.exit(1 if bad else 0)
          PY

      - name: Verify import
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install dist/*.whl
          python - <<'PY'
          import svy_io, svy_io.svyreadstat_rs as _m
          print("OK:", svy_io.__name__, getattr(svy_io, "__version__", "n/a"), _m.__name__)
          PY

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.python-version }}${{ matrix.target && format('-{0}', matrix.target) || '' }}
          path: dist/*.whl

  sdist:
    name: Source dist
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
      - uses: dtolnay/rust-toolchain@stable
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
          manylinux: "2_28"
      - name: Show sdist
        run: ls -lh dist
      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  publish:
    name: Publish to PyPI
    needs: [build-wheels, sdist]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist
      - uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: Validate wheels (publish)
        shell: bash
        run: |
          python - <<'PY'
          import glob, zipfile, sys
          bad = False
          for whl in glob.glob("dist/*.whl"):
              if not zipfile.is_zipfile(whl):
                  print("Bad wheel:", whl)
                  bad = True
          sys.exit(1 if bad else 0)
          PY

      - name: Upload (PyPI)
        uses: PyO3/maturin-action@v1
        with:
          command: upload
          args: --skip-existing dist/*
